{% extends 'base.html' %}

{% block title %}Ã–ÄŸrenci Paneli - MIT Style{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 style="font-weight: 300; color: #555;">HoÅŸgeldin, <strong style="color: #000;">Ã–ÄŸrenci</strong></h2>
            <p class="text-muted">KampÃ¼steki en son etkinlikleri yapay zeka ile keÅŸfet.</p>
            <hr style="border-top: 2px solid #A31F34; width: 50px; opacity: 1;">
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-md-8 mx-auto">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Etkinlik ara (Ã–rn: Konser, Bilim, Spor)..." style="border-radius: 0; border: 1px solid #ccc;">
                <button class="btn btn-dark" type="button" onclick="searchEvents()" style="border-radius: 0; padding-left: 30px; padding-right: 30px;">
                    <i class="fas fa-search"></i> ARA
                </button>
            </div>
            <small class="text-muted mt-2 d-block text-center">AI Destekli Semantik Arama</small>
        </div>
    </div>

    <div id="searchResults" class="row mb-4" style="display:none;"></div>

    <div id="defaultList" class="row">
        <h4 class="mb-3" style="font-size: 16px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; color: #A31F34;">YaklaÅŸan Etkinlikler</h4>
        
        {% for event in events %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 card-mit">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-light text-dark border">{{ event.date|date:"d M Y" }}</span>
                        <small class="text-muted"><i class="far fa-clock"></i> 14:00</small>
                    </div>
                    <h5 class="card-title" style="font-weight: 700;">{{ event.title }}</h5>
                    <p class="card-text text-muted" style="font-size: 14px;">{{ event.description|truncatechars:80 }}</p>
                    
                    <div class="mt-3">
                        {% for tag in event.tags.all %}
                            <span class="badge" style="background-color: #eee; color: #333; font-weight: normal; border: 1px solid #ddd;">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-white border-0">
                    <button class="btn btn-outline-dark btn-sm w-100" style="border-radius: 0;">DETAYLAR</button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <p class="text-muted">HenÃ¼z etkinlik bulunmuyor.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sayfa yÃ¼klendiÄŸinde Enter tuÅŸunu dinle
    document.getElementById("searchInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            searchEvents();
        }
    });

    function searchEvents() {
        const query = document.getElementById('searchInput').value.trim(); // BoÅŸluklarÄ± temizle
        const defaultList = document.getElementById('defaultList');
        const searchResults = document.getElementById('searchResults');
        
        // EÄŸer kutu boÅŸsa varsayÄ±lan listeyi geri getir
        if(!query) {
            defaultList.style.display = 'flex';
            searchResults.style.display = 'none';
            return;
        }

        // KullanÄ±cÄ±ya aramanÄ±n baÅŸladÄ±ÄŸÄ±nÄ± hissettir (Buton yazÄ±sÄ± deÄŸiÅŸsin)
        const btn = document.querySelector('.input-group button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        console.log(`ðŸ” Arama yapÄ±lÄ±yor: ${query}`); // Konsola log atalÄ±m

        fetch(`/api/search-events/?q=${encodeURIComponent(query)}`)
        .then(res => {
            if (!res.ok) throw new Error("Sunucu hatasÄ±!");
            return res.json();
        })
        .then(data => {
            console.log("âœ… SonuÃ§lar geldi:", data); // Gelen veriyi gÃ¶relim

            defaultList.style.display = 'none';
            searchResults.style.display = 'flex';
            searchResults.innerHTML = '<h4 class="mb-3 w-100" style="color:#A31F34;">Arama SonuÃ§larÄ±</h4>';

            if(!data.results || data.results.length === 0) {
                searchResults.innerHTML += `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">"${query}" ile ilgili semantik bir eÅŸleÅŸme bulunamadÄ±.</p>
                        <button class="btn btn-outline-dark btn-sm" onclick="location.reload()">Listeyi SÄ±fÄ±rla</button>
                    </div>`;
            } else {
                data.results.forEach(event => {
                    // Etiketleri gÃ¼venli ÅŸekilde oluÅŸtur
                    let tagsHtml = "";
                    if(event.tags && event.tags.length > 0){
                        tagsHtml = event.tags.map(t => `<span class="badge bg-light text-dark border me-1">${t}</span>`).join('');
                    }

                    let html = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 card-mit">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">${event.title}</h5>
                                <p class="card-text small text-muted">${event.description.substring(0, 80)}...</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="text-danger small fw-bold">
                                        <i class="fas fa-bullseye"></i> ${event.score || 'N/A'}
                                    </div>
                                    <small class="text-muted">AI Match</small>
                                </div>
                                <div class="mt-2">${tagsHtml}</div>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button class="btn btn-dark btn-sm w-100" style="border-radius:0;">Ä°NCELE</button>
                            </div>
                        </div>
                    </div>`;
                    searchResults.innerHTML += html;
                });
            }
        })
        .catch(error => {
            console.error("âŒ Hata:", error);
            alert("Arama sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen terminali kontrol edin.");
        })
        .finally(() => {
            // Butonu eski haline getir
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
</script>
{% endblock %}