{% extends 'base.html' %}

{% block title %}Neural Network - AI Grafiği{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">

<style>
    #graph-wrapper {
        position: relative;
        width: 100%;
        height: 75vh;
        background: radial-gradient(circle at center, #1a1a2e 0%, #16213e 100%);
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        overflow: hidden;
        border: 1px solid #30475e;
    }

    #network-container {
        width: 100%;
        height: 100%;
    }

    .loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(26, 26, 46, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #00d4ff;
        font-family: 'Orbitron', sans-serif;
        z-index: 10;
        transition: opacity 0.5s ease;
    }

    .info-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.6);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #00d4ff;
        color: white;
        font-family: 'Roboto', sans-serif;
        backdrop-filter: blur(5px);
        max-width: 300px;
        z-index: 5;
    }

    .info-panel h4 {
        margin: 0 0 5px 0;
        font-family: 'Orbitron', sans-serif;
        color: #00d4ff;
        font-size: 16px;
    }
    
    .info-panel p {
        font-size: 12px;
        color: #ccc;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <div id="graph-wrapper">
        <div class="info-panel">
            <h4><i class="fas fa-project-diagram"></i> Semantik Ağ</h4>
            <p>Yapay zeka tarafından analiz edilen etkinliklerin anlamsal ilişki haritası. Çizgi kalınlığı, benzerlik oranını gösterir.</p>
            <small class="text-muted mt-2 d-block"><i class="fas fa-mouse"></i> Zoom: Scroll | <i class="fas fa-hand-paper"></i> Pan: Sürükle</small>
        </div>
        <div class="info-panel" style="top: 150px; border-left-color: #00ff9d;">
            <h4><i class="fas fa-chart-pie"></i> Veri Analitiği</h4>
            <div id="stats-content">
                <p>Hesaplanıyor...</p>
            </div>
        </div>
        <div id="loading" class="loading-overlay">
            <div class="spinner-border mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
            <span>AI Verileri İşliyor...</span>
        </div>

        <div id="network-container"></div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const loading = document.getElementById('loading');
        
        fetch('/api/graph-data/')
            .then(response => response.json())
            .then(data => {
                
                // 1. DÜĞÜMLERİ HAZIRLA
                const processedNodes = data.nodes.map(node => ({
                    id: node.id,
                    title: `<strong>${node.label}</strong>`, // Mouse gelince yazı çıkar
                    shape: 'dot',
                    size: 20,
                    color: {
                        background: node.color,
                        border: '#ffffff',
                        highlight: { background: '#ffffff', border: node.color},
                        hover: { background: node.color, border: '#fff' }
                    },
                    font: { size: 0 }, // Ekranda yazı kalabalığını engellemek için 0 yaptık
                    borderWidth: 1,
                    shadow: { enabled: true, color: node.color, size: 5 }
                }));

                // 2. KENARLARI (ÇİZGİLERİ) HAZIRLA
                const processedEdges = data.edges.map(edge => ({
                    from: edge.from,
                    to: edge.to,
                    width: Math.max(1, edge.value * 15), 
                    color: { color: 'rgba(255, 255, 255, 0.5)', highlight: '#00d4ff' }, 
                    smooth: { type: 'continuous' },
                    title: edge.title
                }));

                var container = document.getElementById('network-container');
                var graphData = { nodes: new vis.DataSet(processedNodes), edges: new vis.DataSet(processedEdges) };

                var options = {
                    nodes: { 
                        borderWidthSelected: 2,
                        shape: 'dot',
                        size: 25,
                        font: {
                            size: 16, // Yazıları biraz büyüttük, okunur olsun
                            color: '#ffffff',
                            strokeWidth: 2,
                            strokeColor: '#000000'
                        }
                    },
                    edges: {
                        width: 2,
                        color: { inherit: 'from', opacity: 0.5 },
                        smooth: { type: 'continuous' }
                    },
                    physics: {
                        enabled: true,
                        solver: 'barnesHut',
                        barnesHut: {
                            // İTME GÜCÜ: Bunu artırarak (-30000) birbirlerinden kaçmalarını sağladık
                            gravitationalConstant: -30000, 
                            
                            // MERKEZ ÇEKİMİ: Bunu düşürerek (0.005) ortaya toplanmalarını engelledik
                            centralGravity: 0.005, 
                            
                            // YAY UZUNLUĞU: Bağlantı iplerini uzattık
                            springLength: 300, 
                            
                            springConstant: 0.01, // Yaylar daha gevşek
                            damping: 0.09,
                            avoidOverlap: 1 // Üst üste binmeyi kesinlikle engelle
                        },
                        stabilization: {
                            enabled: true,
                            iterations: 1000,
                            updateInterval: 25,
                            fit: true
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 50,
                        zoomView: true,
                        dragNodes: true,
                        navigationButtons: true, // Sağ alta zoom butonları ekler
                        keyboard: true
                    },
                    layout: {
                        improvedLayout: false,
                        randomSeed: 2
                    }
                };

                // 4. NETWORK'Ü OLUŞTUR
                var network = new vis.Network(container, graphData, options);

                // 5. OLAYLARI DİNLE (EVENTS)
                
                // Yerleşim bitince Loading'i kapat ve fiziği durdur (Kasmaması için)
                network.on("stabilized", function (params) {
                    console.log("Yerleşim bitti, fizik durduruluyor.");
                    network.setOptions({ physics: { enabled: false } });
                    
                    loading.style.opacity = '0';
                    setTimeout(() => loading.style.display = 'none', 500);
                });

                // Sürüklemeye başlayınca fiziği aç
                network.on("dragStart", function (params) {
                    if (params.nodes.length > 0) network.setOptions({ physics: { enabled: true } });
                });

                // Sürükleme bitince fiziği kapat
                network.on("dragEnd", function (params) {
                   network.setOptions({ physics: { enabled: false } });
                });

                // Tıklama olayı
                network.on("click", function (params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const clickedNode = processedNodes.find(n => n.id === nodeId);
                        
                        // HTML içeriğini temizle (title içindeki <strong> tagini kaldır)
                        const cleanLabel = clickedNode.title.replace(/<\/?[^>]+(>|$)/g, "");

                        Swal.fire({
                            title: cleanLabel,
                            text: 'Bu etkinliğin bağlantıları vurgulandı.',
                            icon: 'info',
                            confirmButtonText: 'Tamam',
                            background: '#1a1a2e',
                            color: '#fff',
                            confirmButtonColor: '#00d4ff'
                        });
                    }
                });

                // 6. İSTATİSTİKLERİ HESAPLA
                const clusterCounts = {};
                data.nodes.forEach(node => {
                    clusterCounts[node.group] = (clusterCounts[node.group] || 0) + 1;
                });
                
                let statsHtml = "";
                Object.keys(clusterCounts).forEach(groupId => {
                    const count = clusterCounts[groupId];
                    const percentage = ((count / data.nodes.length) * 100).toFixed(0);
                    const colors = ["#ff0055", "#00d4ff", "#00ff9d", "#ffcc00", "#9d00ff"];
                    const color = colors[groupId % colors.length];
                    
                    statsHtml += `<div style="margin-bottom:5px;">
                        <span style="color:${color}">●</span> Küme ${groupId}: <strong>%${percentage}</strong> (${count} Etkinlik)
                    </div>`;
                });
                document.getElementById('stats-content').innerHTML = statsHtml;            
            })
            .catch(error => {
                console.error('Hata:', error);
                loading.innerHTML = '<span class="text-danger">Veri yüklenemedi!</span>';
            });
    });
</script>
{% endblock %}